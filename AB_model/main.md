- [1. Juliaファイル実行の推奨環境](#1-juliaファイル実行の推奨環境)
  - [1.1. RAM](#11-ram)
- [2. エージェント番号](#2-エージェント番号)
- [3. モデルの式とアルゴリズム](#3-モデルの式とアルゴリズム)
- [4. グラフの読み取りについて](#4-グラフの読み取りについて)
- [5. モデルの性質](#5-モデルの性質)
  - [5.1. 長期均衡状態の性質](#51-長期均衡状態の性質)
- [6. 修正・変更・拡張の方向性](#6-修正変更拡張の方向性)
  - [6.1. 問題](#61-問題)
  - [6.2. 今後必ずしたいこと](#62-今後必ずしたいこと)
  - [6.3. 実施を検討していること](#63-実施を検討していること)


# 1. Juliaファイル実行の推奨環境
## 1.1. RAM
最低8GB、推奨16GB以上。大きければ大きいほど、エージェント数や実行時間を増やせる。

ほとんどミニマムな条件

$J, O, N, TIME, Oin  = 1000, 10, 3, 200, 1$

$OBuffer = O + TIME*Oin$

でも、実行のために4GB程度使っていた。実行速度はCPU次第だろうが、上の条件だと、一瞬ではないが待てない時間ではない、くらいの時間で実行できるはず。

# 2. エージェント番号
|      | インデックス | 総数 |
| :--- | :----------: | :--: |
| 家計 |     $j$      | $J$  |
| 企業 |     $o$      | $O$  |
| 銀行 |     $n$      | $N$  |

**変数の右上につけて**、どのエージェントとどのエージェントの取引もしくは貸借関係なのかを区別する

# 3. モデルの式とアルゴリズム

変数の定義を兼ねた、会計的整合性を表す表は、[matrix.md](https://github.com/rokaboNatttsu/SFC_7/blob/main/AB_model/matrix.md)に記載している。

randn() : 標準化された正規分布で確率分布が表される、乱数からのサンプル

ストック変数 $X$ の期首あるいは前期末の値を $X_{-1}$ と表記する。フロー変数 $Y$ の前期の値を $Y_{-1}$ と表記する。

計算順に式を一覧する

1. $p^o=\nu_2(1+\nu_1+\nu_3\frac{i_{-1}^o}{u^T \gamma_1 k_{-1}^o})\frac{\sum_j W_{-1}^{j,o}+T_{v-1}^o+T_{c-1}^o+r_L\sum_n L_{f-1}^{o,n}+\delta k_{-1}^o}{u^T \gamma_1 k_{-1}^o} + (1-\nu_2)\bar{p}$
   1. ここで、 $\bar{p}=\frac{\sum_o p_{-1}^o(\sum_j c_{-1}^{o,j} + g_{-1}^o)}{\sum_o(\sum_j c_{-1}^{o,j}+g_{-1}^o)}$
2. 就業・失業判定、賃金率と賃金の決定のアルゴリズム
   1. 前期の労働稼働率が１より大きいときは、労働稼働率が１になる水準の求人を出す
   2. 前期就業していた人の一定割合はその企業での就業を続行
   3. 前期就業していた人のうち、勤め先が倒産した人は、一定確立で即座に求人に応募する
   4. 前期就業していて勤め先が倒産していない人のうち、一定割合がその仕事をやめ、一定確立で即座に求人に応募
   5. 前期失業していた人の中からランダムで、起業する
   6. 前期失業していて企業もしない人は、求人に応募する。応募先は求人数に比例してランダムに選ぶ
   7. 求人数が満たされるまでランダムで応募してきた人を雇う
   8. 前期就業していた人に賃金を支払い。賃金の支払いは前期就業していた企業 $o'$ から行われる。金額は、その企業の前期の労働稼働率 $v_{-1}^{o'}$ と家計の要求賃金率 $w_{-1}^j$ の積 $W^{j,o'}=v_{-1}^{o'}w_{-1}^j$
   9. 従業員がいなくなった企業を倒産させる。倒産処理は後述
   10. 今期就業中の家計の要求賃金率 $w^j$ を前期の値 $w^j_{-1}$ より上げる。 $w^j=w^j_{-1}(1+\zeta_2 \times| randn() |)$
   11. 今期失業中の家計の要求賃金率 $w^j$ を前期の値 $w^j_{-1}$ より下げる。 $w^j=w^j_{-1}(1-\zeta_3 \times | randn() |)$
3.  $T_i^j=\tau_1 \sum_j (W_{-1}^{j,o}+IT^j_{h-1}+P_{h-1}^{j,o}+S_{-1}^{j,n})$
4.  $T_a^j=\tau_2(\sum_o E_{h-1}^{o,j}+\sum_n F^{n,j}+\sum_n M_{h-1}^{n,j}-\sum_n L_{h-1}^{j,n})$
5. $T_v^o=\tau_3(\sum_j C_{-1}^{o,j}+I_{-1}^o+G_{-1}^o)$
6. $T_c^o=\max(0, \tau_4 P^o_{-1})$
7. 名目政府支出の需要のアルゴリズム
   1. $G_{sum}=G_0(1+\beta_1)^{(t-1)}$
   2. $x^o=\max[1, x_{-1}^o \{1-\beta_2+\beta_3 randn()\}]$
   3. $z^o=\max(0, x^o-\beta_4) (k^o_{t-1})^{\beta_5}$
   4. $G^{o,D}=\frac{z^o G_{sum}}{\sum z^o}$
   5. 下限付きべき分布みたいなものを作って(xがこれにあたる)、一定の値を差し引いて保有する実質資本の$\beta_5$乗した(zがこれに当たる)後に、政府支出総額に合わせて全体的に値を大きくする。
8.  $g^{o,D}=\frac{G^{o,D}}{p^o}$
9.  家計の消費需要
    1. $Cs^o=\max \{ \alpha_4\frac{\sum_j\sum_o C_{-1}^{o,j}}{J}, \alpha_1(\sum_o W_{-1}^{o,j}-T_a^j-T_i^j-r_L \sum_n L_{h-1}^{j,n}+IT_{h-1}^j+\sum_o P_{h-1}^{o,j}+\sum_n S_{-1}^{n,j}) + \alpha_2(\sum_o E_{h-1}^{o,j}+\sum_n M_{h-1}^{n,j}-\sum_n L_{h-1}^{n,j}) \}$
10. 消費財の購入先選択アルゴリズム
    1.  前回消費財を買った企業$o$から別の企業に乗り換える確率は $rand() < \alpha_3 \frac{p^{o}-\overline{p}}{\overline{p}}$ とする。 $\overline{p}$ は平均価格で、前期の家計の消費と政府支出の名目値の合計を、前期の家計の消費と政府支出の実質値で割った値。消費の乗り換え先は「前期の実質生産量($\sum_j c_{-1}^{o,j}+g_{-1}^o$)」に比例する確率でランダムに決める
    2.  今期の消費財購入先の企業を$o'$と書くことにすると、今期の消費需要は、 $c^{o',j,D}=\frac{Cs^{o'}}{p^{o'}}$ で決める。 $o'$ 以外のすべての企業の商品は消費しない( $c^{o,j}=0 \ \ \ \{ o \mid o \neq o'\}$ )
11. $i^{o,D}=\max[0, \min \{ \delta k_{-1}^o + (u^o-u^T)\gamma_1 k_{-1}^o, \gamma_2\frac{\sum_n M_{f-1}^{n,o}-\sum_n L_{f-1}^{o,n}}{p^o}\}]$
12. $u^{o,D} = \frac{\sum_j c^{o,j,D}+i^{o,D}+g^{o,D}}{\gamma_1 k_{-1}^o}$
13. 資本稼働率 $u^o$ が１以下になるように、需要が多すぎるときは供給量を減らす。
    1.  $u^o = \frac{u^{o,D}}{\max(1, u^{o,D})}$
    2.  $G^o = \frac{G^{o,D}}{\max(1, G^{o,D})}$
    3.  $g^o = \frac{g^{o,D}}{\max(1, g^{o,D})}$
    4.  $c^{o,j} = \frac{c^{o,j,D}}{\max(1, c^{o,j,D})}$
    5.  $i^o = \frac{i^{o,D}}{\max(1, i^{o,D})}$
14. $C^{o,j}=p^o c^{o,j}$
15. $I^o=p^o i^o$
16. $A^o=A_{-1}^o(1 + \mu_1 + \mu_2 \frac{i_{-1}^o}{k_{-1}^o})$
    1.  技術水準上昇率が投資の一次関数として決まる。技術水準は、労働者一人時間あたりが扱う資本の量で表される。技術水準が上がるほど資本の量が増えるのでは？という発想。「情報と秩序」というタイトルの本からインスピレーションを受けている
17. $k^o=(1-\delta)k_{-1}^o+i^o$
18. $K^o=p^o k^o$
19. 政府から家計への所得移転
    1.  失業しているとき $IT^j_h=\chi_1 \frac{\sum_j\sum_o C_{-1}^{o,j}+\sum_o G_{-1}^o}{J}$
    2.  就業しているとき $IT^j_h=\chi_1 \frac{\sum_j\sum_o C_{-1}^{o,j}+\sum_o G_{-1}^o}{J}+\chi_2 \frac{\sum_j\sum_o C_{-1}^{o,j}}{J}$
20. $P^o=\sum_j C^{o,j}+G^o+I^o-\sum_j W^{j,o}-T_c^o-T_v^o-r_L \sum_n L_{f-1}^{o,n}$
21. $P_h^{j,o}=\max\{0, \theta_1(P^o-I^o)+\theta_2(\sum_n M_{f-1}^{o,n}-\sum_n L_{f-1}^{o,n})\}\frac{e_{h-1}^{o,j}}{e_{-1}^o}$
22. $P_b^{n,o}=\max\{0, \theta_1(P^o-I^o)+\theta_2(\sum_n M_{f-1}^{o,n}-\sum_n L_{f-1}^{o,n})\}\frac{e_{b-1}^{o,n}}{e_{-1}^o}$
23. $P_f^o=P^o-\sum_j P_h^{j,o}-\sum_n P_b^{n,o}$
24. $S^{j,n}=\max[\{\theta_1(r_L L_{-1}^n+\sum_o P_b^{n,o})+\theta_2 \sum_o E_{b-1}^{o,n}\}\frac{f_{h-1}^{j,n}}{f_{-1}^n}]$
25. $NL_h^j=-\sum_o C^{o,j}+\sum_o W^{j,o}-T_i^j-T_a^j-r_L \sum_n L_{h-1}^{j,n}IT_h^j+\sum_o P_h^{j,o}+\sum_n S^{j,n}$
26. $NL_f^o=-I^o+P_f^o$
27. $NL_b^n=r_L (\sum_j Lh_{-1}^{j,n} + \sum_o Lf_{-1}^{o,n})+\sum_o P_b^{o,n}-\sum_j S^{j,n}$
28. $NL_g=-\sum_o G^o+\sum_j T_i^j+\sum_j T_a^j+\sum_o T_v^o+\sum_o T_c^o-\sum_j IT_h^j$
29. 起業
    1. $NW_{h-1}^j$ に比例する確立で新規企業の独占的株主に選ぶ
    2. 失業者の中からランダムに起業家を選ぶ
    3. 株主の保有する預金の一定割合を資本金とする
    4. 新規企業は価格のつかない資本を持つ。資本の量は資本金を消費財物価で割った値
    5. 既存企業から実質生産量に比例する確立で技術水準をコピー
    6. $Oin$ 回繰り返す
30. 企業の資金純調達需要の計算
    1.  $FR^o=\sum_j W^{j,o}+T_v^o+T_c^o+r_L\sum_n L_{f-1}^{o,n}-\phi_1 \sum_n M_{f-1}^{n,o}$
31. $\Delta e^o=\min(\max[-\lambda_7 e_{-1}^o, \frac{\{\lambda_3+\lambda_4(r_L - \frac{P^o-P_f^o}{\sum_j E_{h-1}^{o,j}+\sum_n E_{b-1}^{o,n}})\}FR^o}{p_{e-1}^o} ], \lambda_8 e_{-1}^o)$ で株式による資金純調達
32. 企業の純借入
    1. $FRL^o = FR^o-p_{e-1}^o\Delta e^o$ 資金純調達需要のうち株式で調達した額を差し引き、借入金で純調達する金額を計算
    2. $\Delta Lfs^o=\max(-\sum_n L_{f-1}^{o,n}, FRL^o)$
    3. 預金口座を持つ銀行 $n$ で借入金を増減 $L_f^{o,n}=\sum_{n'} L_{f-1}^{o,n'}+\Delta Lfs^o$ , $\Delta L_f^{o,n}=L_f^{o,n}-L_{f-1}^{o,n}$
33. $E^o=E_{-1}^o+p_{e-1}^o\Delta e^o$
34. $e^o=e_{-1}^o+\Delta e^o$
35. 家計の株保有額の決定
    1. $Vs^j=\max(0, -\sum_n L_{h-1}^{j,n}+\sum_n M_{h-1}^{n,j}+\sum_o E_{h-1}^{o,j}+\sum_n F_{h-1}^{n,j}+NL_h^j - \lambda_{10}\sum_n M_{h-1}^{n,j})$ 起業する企業の株式を除く、今期末の金融資産額の予想額を計算
    2. 「企業の保有する預金-借入金」と「キャッシュフロー黒字」の一次関数に比例する重みと、期首に保有している保有学に比例する重みの和で、株式選択確立を計算
    3. $Vs^o$ の、株式の配当率の一次関数で決まる割合を、期末の株式保有総額に決める
    4. 期末の株式保有額を１以上に分割し、分割された金額ごとに、株式選択確立で保有額を配分
    5. 起業する企業の株式の株式保有高を追加
36. $f^o=f_{-1}^o$ 銀行の株式数量は不変とする
37. $F^o=F_{-1}^o$ 銀行が株式の純発行が０なので、銀行の資本金は不変
38. $p_f^n=\frac{\sum_j F_h^{n,j}}{f^n}$
39. $f_h^{n,j}=\frac{F_h^{n,j}}{p_f^n}$
40. $\Delta f_h^{n,j}=f_h^{n,j}-f_{h-1}^{n,j}$
41. 銀行の、企業株式の保有額を計算
    1. 企業の「預金保有残高-借入金残高」が高いほど、キャッシュフロー黒字が大きいほど、値が大きくなるような重み付け指標を作る
    2. 重み付け指標と期首の株式保有額に比例する重みの和で、期末の株式保有額総額に対する株式保有割合 $prob^{n,o}$ を決める
    3. 期首の株式保有額と純貸付(銀行のキャッシュフロー黒字)の和を基準とし、「企業株式の収益率-借入金の金利」が大きいほど期末の株式保有額が増えるよう調整し、期末の株式保有総額 $E_{volume}^n$ を決定
    4. $E_b^{o,n}=E_{volume}^n prob^{n,o}$ 銀行の株式保有額を決定
42. $p_e^o=\frac{\sum_j E_h^{o,j}+\sum_n E_b^{o,n}}{e^o}$
43. $e_h^{o,j}=\frac{E_h^{o,j}}{p_e^o}$
44. $e_b^{o,n}=\frac{E_b^{o,n}}{p_e^o}$
45. $\Delta e_h^{o,j}=e_h^{o,j}-e_{h-1}^{o,j}$
46. $\Delta e_b^{o,n}=e_b^{o,n}-e_{b-1}^{o,n}$
47. 家計の借入金の決定
    1. 期末の資金需要を満たすために、期首の預金保有額に加えていくら追加する必要があるか計算 $tmp^j=\sum_n M_{h-1}^{j,n}+NL_h^j-\sum_o(p_{e-1}^o \Delta e_{h-1}^{o,j})-\sum_n p_{f-1}^n\Delta f_h^{n,j}$
    2. 家計の純貸出と消費の一次関数と、家計の資金がショートしない水準より少し多く借り入れる関数の、大きい値を取る方を借入金需要 $Lhs^j$ として採用する $Lhs^j=\max\{0, \epsilon_1NL_h^j+\epsilon_2\sum_o C^{o,j}, \sum_n L_{h-1}^{j,n}+tmp^j \}$
    3. 預金口座を持つ銀行で借入金の水準を更新 $L_h^{j,n}=Lhs^j$
48. $\Delta L_h^{j,n}=L_h^{j,n}-L_{h-1}^{j,n}$
49. 家計の預金の決定
    1. 預金総額の変化 $\Delta M_h^jsum$ を資金フローの一貫性を表す恒等式から算出 $\Delta M_h^jsum=NL_h^j-\sum_o p_{e-1}\Delta e_h^{o,j}-\sum_n p_{f-1}\Delta f_b^{n,j}+\sum_o \Delta L_h^{j,n}$
    2. 預金と預金フローを計算 $M_h^{n,j}=\sum_{n'} M_{h-1}^{n',j}+\Delta M_h^jsum$ , $\Delta M_h^{n,j}=M_h^{n,j}-M_{h-1}^{n,j}$
50. 企業の預金の決定
    1. 預金総額の変化 $\Delta M_f^osum$ を資金フローの一貫性を表す恒等式から算出 $\Delta M_f^osum=NL_f^o+\sum_o p_{e-1}\Delta e^o+\sum_n \Delta L_f^{o,n}$
    2. 預金と預金フローを計算 $M_f^{n,o}=\sum_{n'} M_{f-1}^{n',o}+\Delta M_f^osum$ , $\Delta M_f^{n,o}=M_f^{n,o}-M_{f-1}^{n,o}$
51. $M^n=\sum_j M_h^{n,j}+\sum_o M_f^{n,o}$
52. $\Delta M^n=\sum_j \Delta M_h^{n,j}+\sum_o \Delta M_f^{n,o}$
53. $\Delta H^n=NL_b^n-\sum_o p_{e-1}\Delta e_b^{o,n}+\Delta M^n-\Delta L^n-\Delta Z_b^n$
54. $H^n=H_{-1}^n+\Delta H^n$
55. $NW_h^j=\sum_n M_h^{n,j}-\sum_n L_h^{j,n}+\sum_o E_h^{o,j}+\sum_n F_h^{n,j}$
56. $NW_f^o=K^o+\sum_n M_f^{n,o}-\sum_n L_f^{o,n}-E^o$
57. $NW_b^n=-M^n+L^n+\sum_o E_b^{o,n}-F^n+H^n$
58. $NW_g=-\sum_n H^n$
59. $NW=\sum_j NW_h^j+\sum_o NW_f+\sum_n NW_b+NW_g$
60. $D_E=-\sum_o E^o+\sum_o\sum_j E_h^{o,j}+\sum_o\sum_j E_b^{o,j}$
61. $D_F=\sum_j\sum_n F_h^{j,n}-\sum_n F^n$
62. $v^o=\frac{u^o k^o}{A^o EMPN^o}$ ここで、$EMPN^o$ は企業 $o$ で今期雇われた家計の数
63. 資金繰りできなくなったことが理由の企業倒産
    1. $\sum_n M_f^{n,o}-\phi_2 \sum_n L_f^{o,n}$ かつ $P^o-I^o<0$ の企業は、倒産処理する
    2. 倒産処理の実行。企業 $o$ が倒産するとき、
       1. $\Delta M_{f+1}^{n,o}=-M_f^{n,o}$
       2. $\Delta L_{f+1}^{o,n}=-L_f^{o,n}$
       3. $\Delta e_{+1}^o=-e^o$
       4. $\Delta e_{h+1}^{o,j}=-e_h^{o,j}$
       5. $\Delta e_{b+1}^{o,n}=-e_b^{o,n}$
       6. $\Delta Z_{f+1}^o=p_e^o\Delta e_{+1}^o-\Delta M_{f+1}^{n_M,o}+\Delta L_{f+1}^{o,n_L}$
       7. $\Delta Z_{b+1}^{n_M}+=\Delta M_{f+1}^{n_M,o}$
       8. $\Delta Z_{b+1}^{n_L}-=\Delta L_{f+1}^{o,n_L}$
       9. $\Delta Z_{b+1}^n-=p_e^o\Delta e_{b+1}^{o,n}$       $(\forall n)$
       10. $\Delta Z_{h+1}^j -= p_e^o\Delta e_{h+1}^{o,j}$

会計的な整合性を実現するために使わなかった冗長な恒等式

- $\sum_j NL_h^j+\sum_o NL_f^o*\sum_n NL_b^n+NL_g=0$
- $NL_h^j-\sum_o p_{e-1}^o\Delta e_h^{o,j}-\sum_n p_{f-1}^n\Delta f_h^{n,j}+\sum_n \Delta L_h^{j,n}-\sum_n \Delta M_h^{n,j}-\Delta Z_h^j=0$
- $NL_f^o+p_{e-1}^o\Delta e_b^o+\sum_n \Delta L_f^{o,n}-\sum_n \Delta M_f^{n,o}-\Delta Z_f^o=0$
- $NL_b^n-\sum_o p_{e-1}^o\Delta e_b^{o,n}-\Delta L^n+\Delta M^n-\Delta H^n-\Delta Z_b^n=0$
- $NL_g+\sum_n \Delta H^n=0$
- $\sum_o K^o+DE+DF-NW=0$

などを使ってモデルの会計的一貫性を確認する

# 4. グラフの読み取りについて

凡例の番号は、エージェントのID

# 5. モデルの性質
## 5.1. 長期均衡状態の性質
- 要求賃金率上昇率-労働節約的技術水準上昇率≒インフレ率≒名目政府支出増加率-実質政府支出増加率
- 労働節約的技術水準上昇率≒実質政府支出増加率
- 要求賃金率上昇率≒名目政府支出増加率

# 6. 修正・変更・拡張の方向性

## 6.1. 問題
- 

## 6.2. 今後必ずしたいこと
- 消費性向を可処分所得と資産と前期平均消費の関数とする。現状、可処分所得と金融資産保有額で決めているが、資産家や高収入の家計が消費性向が低いことを記述したい
- プロットの工夫
  - 企業規模の分布
    - 従業員数
    - 売上
  - 家計資産の分布
- バーンイン期間の後の５０程度の時間を使って、以下の調査
  - 平常状態の性質
  - パラメータの変化に対する反応
  - 平常状態のパラメータ依存性
- 要求賃金率の平均への回帰の傾向の追加。現状、要求賃金率の分布が、時間とともにどんどん広がっていくはず。

## 6.3. 実施を検討していること
- 心電図モニターのように、配列の最後のtまで計算したら最初に戻って上書きする、みたいな仕様にして、配列の大きさを時間方向に圧縮し、メモリ消費量を減らしつつ機能を維持する
- $r_{Lf}=(1-\lambda_{rLf})r_{Lf-1}+\lambda_{rLf}(1+\epsilon_3+\frac{\Delta Z^n}{\sum_o L_{f-1}^{o,n}})$ で企業向けの適応的な金利を導入することを検討
- 起業する企業の資本が何もないところから出てくるのではなく、既存企業の生産した資本を買う形式にする
- 政府や銀行が家計を雇う
- 国債の導入
- 銀行への資本規制の追加
- 金利の内生化
- 預金/借入金の多対多化
- 貸し渋り、貸し剥がしのような与信行動を追加する
- 失業者への社会保障をモデル含める